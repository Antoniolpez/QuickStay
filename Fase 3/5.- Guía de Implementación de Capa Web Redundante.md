# Guía de Implementación de Capa Web Redundante

**Proyecto:** QuickStay - Plataforma de Alquiler Express
**Módulo:** Administración de Sistemas Informáticos en Red (ASIR)
**Autor:** Antonio López Montes
**Fecha:** 23 de Diciembre de 2025

---

## 1. Balanceador de Carga F5 (Simulado)

Para garantizar la alta disponibilidad y escalabilidad de la plataforma web de QuickStay, se implementará un balanceador de carga. Aunque se simula un F5 BIG-IP, los conceptos son aplicables a cualquier solución de balanceo de carga (ej. Nginx, HAProxy).

### 1.1. Configuración de Virtual IP (VIP)

La Virtual IP (VIP) es la dirección IP pública a la que los clientes se conectarán. El balanceador de carga interceptará este tráfico y lo distribuirá a los servidores web internos.

| Parámetro | Valor | Justificación |
| :--- | :--- | :--- |
| **Dirección IP Virtual (VIP)** | `172.16.10.100` | Esta IP estará en la VLAN DMZ y será el punto de entrada para el tráfico web desde Internet (a través del Firewall/NAT). |
| **Puerto de Servicio** | `80` (HTTP), `443` (HTTPS) | El balanceador escuchará en estos puertos para el tráfico web estándar y seguro. |
| **Perfil de Cliente** | `http`, `https` | Define cómo el balanceador interactúa con los clientes (ej. manejo de HTTP/S). |

### 1.2. Creación de Pools de Servidores Web

Los *pools* agrupan los servidores reales (miembros) que alojan la aplicación web. El balanceador distribuirá el tráfico entre los miembros de un *pool*.

| Parámetro | Valor | Justificación |
| :--- | :--- | :--- |
| **Nombre del Pool** | `pool_web_quickstay` | Identificador del grupo de servidores web. |
| **Miembros del Pool** | `webserver1 (172.16.10.11:80/443)`<br>`webserver2 (172.16.10.12:80/443)` | Se asume la existencia de dos servidores web en la VLAN DMZ. |
| **Método de Balanceo** | `Least Connections` | Dirige el tráfico al servidor con menos conexiones activas, optimizando la distribución de carga. |

### 1.3. Health Monitors (Monitores de Salud)

Los *health monitors* verifican continuamente la disponibilidad y el estado de los miembros del *pool*. Si un servidor falla, el balanceador lo retira del *pool* hasta que se recupere.

| Parámetro | Valor | Justificación |
| :--- | :--- | :--- |
| **Tipo de Monitor** | `HTTP`, `HTTPS` | Verifican que el servidor web responde correctamente a las peticiones HTTP/S. |
| **Intervalo** | `5 segundos` | Frecuencia con la que se realiza la verificación. |
| **Timeout** | `16 segundos` | Tiempo máximo de espera para una respuesta antes de marcar el servidor como *DOWN*. |
| **Número de Reintentos** | `3` | Número de fallos consecutivos antes de marcar el servidor como *DOWN*. |

### 1.4. Persistencia de Sesiones

La persistencia de sesiones asegura que las peticiones de un mismo cliente sean dirigidas al mismo servidor *backend* durante un período de tiempo, lo cual es crucial para aplicaciones con estado (ej. carritos de compra, sesiones de usuario).

| Parámetro | Valor | Justificación |
| :--- | :--- | :--- |
| **Tipo de Persistencia** | `Cookie` | El balanceador inserta una cookie en la respuesta del servidor, que luego utiliza para dirigir las peticiones subsiguientes del mismo cliente al mismo servidor. |
| **Tiempo de Vida de la Cookie** | `3600 segundos (1 hora)` | Suficiente para cubrir la duración típica de una sesión de usuario. |

### 1.5. Configuración de SSL Offloading

El SSL Offloading descarga la tarea de cifrado/descifrado SSL/TLS del servidor web al balanceador de carga, mejorando el rendimiento de los servidores *backend*.

| Parámetro | Valor | Justificación |
| :--- | :--- | :--- |
| **Perfil de Cliente SSL** | `clientssl_profile` | Configurado con el certificado SSL/TLS de QuickStay y su clave privada. |
| **Perfil de Servidor SSL** | `serverssl_profile` (opcional) | Si los servidores *backend* también requieren SSL, se configura un perfil para la comunicación segura entre el balanceador y los servidores. Para este diseño, se asume comunicación HTTP interna. |

---

## 2. Servidores Web Redundantes

Se implementarán dos servidores web idénticos en la VLAN DMZ, configurados para trabajar detrás del balanceador de carga.

### 2.1. Instalación y Configuración Base (Apache/Nginx)

Se utilizará Apache HTTP Server (o Nginx) como servidor web. La configuración será idéntica en ambos servidores.

**Servidor:** `webserver1.quickstay.local`
**IP:** `172.16.10.11`
**Servidor:** `webserver2.quickstay.local`
**IP:** `172.16.10.12`

```bash
# En ambos servidores web (webserver1 y webserver2)

# 1. Actualizar el sistema
sudo apt update && sudo apt upgrade -y

# 2. Instalar Apache
sudo apt install -y apache2

# 3. Habilitar módulos necesarios (ej. rewrite, headers)
sudo a2enmod rewrite headers

# 4. Configurar el Virtual Host para QuickStay
# Crear /etc/apache2/sites-available/quickstay.conf
<VirtualHost *:80>
    ServerAdmin admin@quickstay.local
    ServerName quickstay.local
    ServerAlias www.quickstay.local
    DocumentRoot /var/www/html/quickstay
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

# 5. Habilitar el sitio y deshabilitar el sitio por defecto
sudo a2ensite quickstay.conf
sudo a2dissite 000-default.conf

# 6. Reiniciar Apache
sudo systemctl restart apache2
```

### 2.2. Configuración Idéntica (Simulación de Chef/Puppet)

Para asegurar que ambos servidores web sean idénticos, se simulará el uso de una herramienta de gestión de configuración (ej. Chef, Puppet, Ansible). En un entorno real, esto automatizaría la configuración.

```bash
# En un entorno real, se usaría un script o una herramienta de CM para aplicar la misma configuración
# Ejemplo de comando para copiar la configuración de webserver1 a webserver2 (solo para demostración)
# scp /etc/apache2/sites-available/quickstay.conf webserver2:/etc/apache2/sites-available/
```

### 2.3. Contenido Web Sincronizado

El contenido de la aplicación web (`/var/www/html/quickstay`) debe estar sincronizado entre ambos servidores. Se puede usar `rsync` o un sistema de archivos distribuido.

```bash
# En webserver1, después de cualquier cambio en el contenido
# Sincronizar contenido de webserver1 a webserver2
rsync -avz /var/www/html/quickstay/ webserver2:/var/www/html/quickstay/
```

### 2.4. Certificados SSL/TLS

Aunque el SSL Offloading se realiza en el balanceador, los servidores web internos pueden necesitar certificados para la comunicación segura con el balanceador (si se usa `serverssl_profile`) o para pruebas directas.

```bash
# En ambos servidores web, instalar certificados (ej. Let's Encrypt o certificados internos)
# sudo certbot --apache -d quickstay.local -d www.quickstay.local
```

---

## 3. Pruebas de Capa Web

### 3.1. Acceso desde Internet (Simulado)

Verificar que la aplicación web es accesible a través de la VIP del balanceador.

| Prueba | Objetivo | Metodología | Criterio de Éxito |
| :--- | :--- | :--- | :--- |
| **Acceso HTTP/S** | Verificar que la página de inicio de QuickStay carga correctamente. | Desde un cliente externo, acceder a `http://quickstay.local` y `https://quickstay.local`. | La página de inicio debe cargar sin errores y el certificado SSL debe ser válido. |

### 3.2. Failover Manual/Automático

Verificar que el balanceador de carga gestiona correctamente la caída de un servidor web.

| Prueba | Objetivo | Metodología | Criterio de Éxito |
| :--- | :--- | :--- | :--- |
| **Caída de Servidor** | Simular el fallo de `webserver1` y verificar que el tráfico se redirige a `webserver2`. | Detener el servicio Apache en `webserver1`. Realizar múltiples peticiones a la VIP. | Todas las peticiones deben ser atendidas por `webserver2` sin interrupción del servicio. |
| **Recuperación de Servidor** | Verificar que `webserver1` se reincorpora al *pool* una vez recuperado. | Iniciar el servicio Apache en `webserver1`. Monitorear el estado del *pool* en el balanceador. | `webserver1` debe ser marcado como *UP* y comenzar a recibir tráfico. |

### 3.3. Pruebas de Carga Básica

Evaluar el rendimiento de la capa web bajo una carga simulada.

| Prueba | Objetivo | Herramienta | Criterio de Éxito |
| :--- | :--- | :--- | :--- |
| **Carga Concurrente** | Simular 100 usuarios concurrentes durante 5 minutos. | `ab` (ApacheBench) o `locust`. | El tiempo de respuesta promedio debe ser inferior a 200 ms. No deben producirse errores 5xx. |

### 3.4. Verificación de Logs

Confirmar que los logs del balanceador y de los servidores web registran correctamente el tráfico y los eventos.

| Log | Ubicación | Eventos a Verificar | Justificación |
| :--- | :--- | :--- | :--- |
| **Logs del Balanceador** | Interfaz de gestión F5 (o logs de Nginx/HAProxy) | Distribución de tráfico a `webserver1` y `webserver2`, eventos de *health check*. | Confirmar que el balanceo de carga funciona como se espera. |
| **Logs de Apache** | `/var/log/apache2/access.log`<br>`/var/log/apache2/error.log` | Peticiones HTTP/S, errores de aplicación. | Verificar que los servidores web procesan las peticiones correctamente y no hay errores internos. |
| **Logs de Wazuh** | Servidor de Seguridad (Wazuh Manager) | Eventos de seguridad, intentos de acceso no autorizado. | Confirmar que los agentes Wazuh en los servidores web envían los logs al SIEM. |

