# Guía de Implementación de IoT, Monitoreo y Seguridad

**Proyecto:** QuickStay - Plataforma de Alquiler Express
**Módulo:** Administración de Sistemas Informáticos en Red (ASIR)
**Autor:** Antonio López Montes
**Fecha:** 23 de Diciembre de 2025

---

## 1. Infraestructura IoT Redundante

La infraestructura IoT de QuickStay se basa en el protocolo MQTT para la comunicación eficiente y ligera con los dispositivos (cerraduras, sensores). Se implementarán *brokers* MQTT redundantes para asegurar la disponibilidad del servicio.

**Servidor:** `iotgateway1.quickstay.local`
**IP:** `172.16.40.10`
**Servidor:** `iotgateway2.quickstay.local`
**IP:** `172.16.40.11`

### 1.1. Instalación de Mosquitto MQTT (Gateways)

Se instalará el *broker* Mosquitto MQTT en dos servidores en la VLAN OT/IoT para proporcionar redundancia.

```bash
# En ambos servidores IoT Gateway (iotgateway1 y iotgateway2)

# 1. Actualizar el sistema
sudo apt update && sudo apt upgrade -y

# 2. Instalar Mosquitto
sudo apt install -y mosquitto mosquitto-clients

# 3. Habilitar y iniciar el servicio
sudo systemctl enable mosquitto
sudo systemctl start mosquitto
```

### 1.2. Configuración TLS para MQTT

La comunicación MQTT se asegurará mediante TLS para proteger la confidencialidad e integridad de los datos de los dispositivos IoT.

```bash
# En ambos servidores IoT Gateway

# 1. Generar certificados SSL/TLS (ej. con OpenSSL o Let's Encrypt)
# Se asume que ya se tienen los certificados (ca.crt, server.crt, server.key)

# 2. Configurar Mosquitto para usar TLS
# Editar /etc/mosquitto/mosquitto.conf

# Permitir conexiones seguras en el puerto 8883
listener 8883
cafile /etc/mosquitto/certs/ca.crt
certfile /etc/mosquitto/certs/server.crt
keyfile /etc/mosquitto/certs/server.key
require_certificate true # Opcional, para autenticación mutua

# Permitir conexiones no seguras en el puerto 1883 (solo para pruebas internas o dispositivos no críticos)
listener 1883
allow_anonymous true

# 3. Reiniciar Mosquitto
sudo systemctl restart mosquitto
```

### 1.3. Heartbeat entre Gateways

Para la redundancia activa/pasiva o activa/activa, se puede configurar un mecanismo de *heartbeat* o un *cluster* de Mosquitto. Para este diseño, se simulará una configuración donde los dispositivos IoT pueden conectarse a cualquiera de los dos *brokers*.

```bash
# Aunque Mosquitto no tiene un clustering nativo avanzado, se puede usar un balanceador de carga
# delante de ambos brokers o configurar los clientes IoT para que intenten conectarse a iotgateway1 y luego a iotgateway2.

# Para un heartbeat simple (ej. con keepalived para una VIP flotante)
# En iotgateway1 y iotgateway2, instalar keepalived
# sudo apt install -y keepalived

# Configurar keepalived para una VIP compartida (ej. 172.16.40.100) para el servicio MQTT
# Esto permitiría que los dispositivos IoT se conecten a una única IP virtual.
```

### 1.4. Dispositivos IoT Simulados

Se simularán dispositivos IoT (cerraduras, sensores) que se conectarán a los *brokers* MQTT y publicarán/suscribirán mensajes.

```bash
# En un cliente (ej. un Raspberry Pi o un servidor de prueba)

# 1. Publicar un mensaje (simulando un sensor de ocupación)
mosquitto_pub -h iotgateway1.quickstay.local -p 8883 --cafile /etc/mosquitto/certs/ca.crt --cert /etc/mosquitto/certs/client.crt --key /etc/mosquitto/certs/client.key -t "quickstay/property1/sensor/occupancy" -m "occupied"

# 2. Suscribirse a un tema (simulando una cerradura inteligente esperando comandos)
mosquitto_sub -h iotgateway1.quickstay.local -p 8883 --cafile /etc/mosquitto/certs/ca.crt --cert /etc/mosquitto/certs/client.crt --key /etc/mosquitto/certs/client.key -t "quickstay/property1/lock/command"
```

---

## 2. Sistema de Monitoreo (Zabbix)

Zabbix se utilizará para la monitorización proactiva de toda la infraestructura de QuickStay, incluyendo servidores, servicios de red y dispositivos IoT.

**Servidor:** `monitoring.quickstay.local`
**IP:** `172.16.30.20`

### 2.1. Instalación Servidor Zabbix

```bash
# En monitoring.quickstay.local

# 1. Instalar Zabbix Server con MySQL y Apache
# Seguir la documentación oficial de Zabbix para la versión específica (ej. Zabbix 6.0 LTS)
# sudo apt install zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf zabbix-agent

# 2. Configurar la base de datos MySQL para Zabbix
# mysql -uroot -p
# CREATE DATABASE zabbix character set utf8mb4 collate utf8mb4_bin;
# CREATE USER 'zabbix'@'localhost' IDENTIFIED BY 'password';
# GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';
# FLUSH PRIVILEGES;

# 3. Importar el esquema inicial y los datos
# zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix

# 4. Configurar Zabbix Server (editar /etc/zabbix/zabbix_server.conf)
# DBHost=localhost
# DBName=zabbix
# DBUser=zabbix
# DBPassword=password

# 5. Configurar PHP para Zabbix Frontend (editar /etc/php/7.4/apache2/php.ini)
# post_max_size = 16M
# max_execution_time = 300
# max_input_time = 300
# date.timezone = Europe/Madrid

# 6. Reiniciar servicios
sudo systemctl restart zabbix-server apache2 php7.4-fpm
sudo systemctl enable zabbix-server apache2 php7.4-fpm
```

### 2.2. Configuración Agentes en Todos los Servidores

Se instalarán agentes Zabbix en todos los servidores para recopilar métricas de rendimiento y estado.

```bash
# En cada servidor (Web, App, DB, AD-DC, Seguridad, IoT Gateways)

# 1. Instalar Zabbix Agent
sudo apt install -y zabbix-agent

# 2. Configurar Zabbix Agent (editar /etc/zabbix/zabbix_agentd.conf)
# Server=172.16.30.20
# ServerActive=172.16.30.20
# Hostname=<Nombre del Servidor, ej. webserver1.quickstay.local>

# 3. Reiniciar el agente
sudo systemctl restart zabbix-agent
sudo systemctl enable zabbix-agent
```

### 2.3. Plantillas Personalizadas por Servicio

Se crearán o importarán plantillas personalizadas en Zabbix para monitorizar servicios específicos (Apache, MySQL, Tomcat, Mosquitto, etc.).

| Servicio | Plantilla Zabbix | Métricas Clave |
| :--- | :--- | :--- |
| **Servidores Linux** | `Template OS Linux by Zabbix agent` | Carga de CPU, uso de memoria, espacio en disco, tráfico de red. |
| **Apache Web Server** | `Template App Apache HTTP Server by Zabbix agent` | Peticiones por segundo, errores, estado del servidor. |
| **MySQL Database** | `Template DB MySQL by Zabbix agent` | Conexiones, consultas por segundo, latencia, estado de replicación. |
| **Tomcat/WildFly** | `Template App Apache Tomcat by JMX` | Uso de memoria JVM, hilos activos, sesiones. |
| **Mosquitto MQTT** | `Template App Mosquitto MQTT by Zabbix agent` | Conexiones activas, mensajes publicados/recibidos, temas. |

### 2.4. Alertas y Triggers Configurados

Se configurarán *triggers* y acciones de alerta para notificar a los administradores sobre problemas críticos (ej. servidor caído, disco lleno, servicio no disponible).

| Evento | Severidad | Acción | Destinatario |
| :--- | :--- | :--- | :--- |
| **Servidor Caído** | `Disaster` | Notificación por email, SMS | Administradores de Sistemas |
| **Disco Lleno (>90%)** | `High` | Notificación por email | Administradores de Sistemas |
| **Servicio Apache DOWN** | `High` | Notificación por email | Administradores de Sistemas |
| **Replicación MySQL Fallida** | `High` | Notificación por email | Administradores de Bases de Datos |

### 2.5. Dashboard de Monitoreo

Se creará un *dashboard* personalizado en la interfaz web de Zabbix para visualizar el estado general de la infraestructura, los servicios críticos y las alertas activas.

---

## 3. Sistema de Seguridad (Wazuh)

Wazuh se implementará como una plataforma SIEM/XDR para la detección de intrusiones, monitorización de integridad de archivos, análisis de logs y cumplimiento normativo.

**Servidor:** `security.quickstay.local`
**IP:** `172.16.30.30`

### 3.1. Instalación Servidor Wazuh

```bash
# En security.quickstay.local

# 1. Instalar Wazuh Manager, OpenSearch y Filebeat
# Seguir la documentación oficial de Wazuh para la instalación (ej. usando scripts de instalación o paquetes).
# sudo apt install -y wazuh-manager opensearch-dashboards filebeat

# 2. Configurar OpenSearch y Filebeat para Wazuh
# Configurar los certificados SSL/TLS para OpenSearch.
# Configurar Filebeat para enviar logs a OpenSearch.

# 3. Habilitar y iniciar servicios
sudo systemctl enable wazuh-manager opensearch-dashboards filebeat
sudo systemctl start wazuh-manager opensearch-dashboards filebeat
```

### 3.2. Agentes de Seguridad en Endpoints

Se instalarán agentes Wazuh en todos los servidores para recopilar logs, monitorizar la integridad de archivos y detectar amenazas.

```bash
# En cada servidor (Web, App, DB, AD-DC, IoT Gateways)

# 1. Instalar el agente Wazuh
# sudo apt install -y wazuh-agent

# 2. Configurar el agente para conectarse al Wazuh Manager
# Editar /var/ossec/etc/ossec.conf
# <client>
#   <server>
#     <address>172.16.30.30</address>
#   </server>
# </client>

# 3. Registrar el agente en el Wazuh Manager (obtener clave de registro)
# En el Manager:
# /var/ossec/bin/agent-auth -m 172.16.30.30 -p 1515
# En el Agente:
# /var/ossec/bin/manage_agents -i <ID_DEL_AGENTE> -k <CLAVE_DE_REGISTRO>

# 4. Reiniciar el agente
sudo systemctl restart wazuh-agent
sudo systemctl enable wazuh-agent
```

### 3.3. Reglas de Detección Personalizadas

Se crearán reglas personalizadas en Wazuh para detectar eventos de seguridad específicos de la infraestructura de QuickStay (ej. intentos de acceso a cerraduras IoT, fallos de autenticación en AD).

```xml
<!-- Ejemplo de regla personalizada en /var/ossec/etc/rules/local_rules.xml -->
<group name="quickstay_rules">
  <rule id="100001" level="10">
    <if_sid>5503</if_sid> <!-- Regla base para fallos de autenticación -->
    <match>failed password for quickstay_app</match>
    <description>Multiple failed login attempts for QuickStay application user.</description>
    <group>authentication_fail,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_10.6.1,</group>
  </rule>
</group>

# Reiniciar Wazuh Manager después de añadir reglas
sudo systemctl restart wazuh-manager
```

### 3.4. Integración con AD para Autenticación

Wazuh se integrará con Active Directory para la autenticación de usuarios en la interfaz web de Wazuh, permitiendo la gestión de roles y permisos.

```bash
# Configurar la autenticación LDAP en OpenSearch Dashboards para Wazuh
# Editar /etc/opensearch-dashboards/opensearch_dashboards.yml
# Añadir configuración LDAP para conectar con dc1.quickstay.local (172.16.30.10)
```

### 3.5. Sistema de Alertas por Email

Se configurará Wazuh para enviar alertas por correo electrónico a los administradores de seguridad cuando se detecten eventos críticos.

```bash
# Configurar el envío de emails en /var/ossec/etc/ossec.conf
# <global>
#   <email_notification>yes</email_notification>
#   <email_to>security_admin@quickstay.local</email_to>
#   <smtp_server>smtp.quickstay.local</smtp_server>
#   <smtp_port>587</smtp_port>
#   <smtp_auth>yes</smtp_auth>
#   <smtp_user>wazuh@quickstay.local</smtp_user>
#   <smtp_password>smtp_password</smtp_password>
# </global>

# Reiniciar Wazuh Manager
sudo systemctl restart wazuh-manager
```
