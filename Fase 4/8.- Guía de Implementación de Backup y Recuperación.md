# Guía de Implementación de Backup y Recuperación

**Proyecto:** QuickStay - Plataforma de Alquiler Express
**Módulo:** Administración de Sistemas Informáticos en Red (ASIR)
**Autor:** Antonio López Montes
**Fecha:** 23 de Diciembre de 2025

---

## 1. Servidor de Backup Veeam (Simulado) (Días 38-39)

Se implementará un servidor de backup utilizando Veeam Backup & Replication (simulado) para gestionar las copias de seguridad de toda la infraestructura de QuickStay. Este servidor se ubicará en la VLAN de Gestión.

**Servidor:** `backup.quickstay.local`
**IP:** `172.16.30.40`

### 1.1. Instalación del Servidor de Backup

Aunque se simula Veeam, la instalación de un servidor de backup implica la preparación de un sistema operativo (Windows Server o Linux) y la instalación del software de backup.

```bash
# En un entorno real, se instalaría Veeam Backup & Replication en un Windows Server.
# Para una simulación en Linux, se podría usar un servidor de almacenamiento con herramientas como rsync o BorgBackup.

# Ejemplo de instalación de un servidor de almacenamiento básico en Linux
sudo apt update && sudo apt upgrade -y
sudo apt install -y samba nfs-kernel-server

# Configurar comparticiones SMB/NFS para repositorios de backup
```

### 1.2. Configuración de Repositorios de Backup

Los repositorios son las ubicaciones donde se almacenan los datos de backup. Se configurarán dos tipos de repositorios:

*   **Local:** Almacenamiento directo en el servidor de backup.
*   **NAS Simulado:** Un recurso de red (SMB/NFS) para almacenamiento a largo plazo o copias secundarias.

| Repositorio | Tipo | Ubicación | Capacidad Estimada | Justificación |
| :--- | :--- | :--- | :--- | :--- |
| **Local_Repo** | Direct Attached Storage (DAS) | `/mnt/backup_local` | `2 TB` | Almacenamiento rápido para backups a corto plazo y restauraciones rápidas. |
| **NAS_Repo** | Network Attached Storage (NAS) | `//nas.quickstay.local/backups` (SMB) o `/mnt/nas_backups` (NFS) | `10 TB` | Almacenamiento a largo plazo y para cumplir con la regla 3-2-1 de backups (copia fuera del sitio). |

```bash
# Ejemplo de montaje de repositorio NAS en Linux
sudo mkdir /mnt/nas_backups
sudo mount -t nfs nas.quickstay.local:/exports/backups /mnt/nas_backups
# O para SMB
sudo mount -t cifs //nas.quickstay.local/backups /mnt/nas_backups -o username=backupuser,password=backuppass
```

### 1.3. Políticas de Retención

Las políticas de retención definen cuánto tiempo se conservan los backups. Se implementará una estrategia de retención a corto y largo plazo.

| Tipo de Backup | Retención | Justificación |
| :--- | :--- | :--- |
| **Diario** | `30 días` | Permite recuperaciones rápidas de cambios recientes. |
| **Mensual** | `12 meses` | Retención a medio plazo para cumplimiento y recuperación de desastres. |
| **Anual** | `7 años` | Retención a largo plazo para cumplimiento normativo y auditorías.

### 1.4. Jobs de Backup por Tipo de Servidor

Se crearán jobs de backup específicos para cada tipo de servidor, adaptando la frecuencia y el tipo de backup a la criticidad de los datos.

| Job de Backup | Tipo de Servidor | Frecuencia | Tipo de Backup | Repositorio | Justificación |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Job_WebServers** | Servidores Web (webserver1, webserver2) | Diario (Incremental) | VM-level | Local_Repo | Recuperación rápida de la VM completa. |
| **Job_AppServers** | Servidores de Aplicación (appserver1, appserver2) | Diario (Incremental) | VM-level | Local_Repo | Recuperación rápida de la VM completa. |
| **Job_DBServers** | Servidores de Base de Datos (db1, db2) | Diario (Incremental) | Application-aware | Local_Repo | Consistencia transaccional de la base de datos. |
| **Job_ADDCs** | Controladores de Dominio (dc1, dc2) | Diario (Incremental) | System State | Local_Repo | Recuperación del estado del Directorio Activo. |
| **Job_SecurityServer** | Servidor de Seguridad (security) | Semanal (Completo) | VM-level | Local_Repo | Recuperación de la configuración y datos de Wazuh/Suricata. |
| **Job_LongTerm** | Todos los servidores críticos | Mensual (Completo) | VM-level | NAS_Repo | Cumplimiento de retención a largo plazo. |

---

## 2. Configuración de Agentes de Backup

Se instalarán agentes de backup en todos los servidores para permitir la comunicación con el servidor de backup y realizar copias de seguridad a nivel de sistema operativo y aplicación.

### 2.1. Agente Veeam en Todos los Servidores

```bash
# En cada servidor (Web, App, DB, AD-DC, Seguridad)

# 1. Descargar e instalar el agente Veeam para Linux (o el agente correspondiente para el SO)
# sudo dpkg -i veeam-release-deb_1.0.8_all.deb
# sudo apt update
# sudo apt install -y veeam-backup-agent

# 2. Configurar el agente para conectarse al servidor de backup
# sudo veeamconfig agent config --set-server 172.16.30.40 --set-port 10001
# sudo veeamconfig agent start
```

### 2.2. Backup de Aplicaciones (Consistencia App-Aware)

Para aplicaciones como MySQL, es crucial realizar backups *app-aware* para asegurar la consistencia transaccional de los datos. Veeam (simulado) utiliza *VSS* (Volume Shadow Copy Service) en Windows o *pre/post scripts* en Linux.

```bash
# En los servidores de aplicación, asegurar que la aplicación esté configurada para backups app-aware.
# En Linux, esto implica scripts que detienen/reanudan la aplicación o vacían buffers antes/después del snapshot.
```

### 2.3. Backup de BD (Pre/Post Scripts para MySQL)

Para MySQL, se utilizarán scripts personalizados para garantizar un backup consistente, especialmente en el Master.

```bash
# Ejemplo de pre-script para MySQL (en db1)
# /etc/veeam/scripts/mysql_pre_backup.sh
#!/bin/bash
mysql -u root -p"your_mysql_root_password" -e "FLUSH TABLES WITH READ LOCK;"

# Ejemplo de post-script para MySQL (en db1)
# /etc/veeam/scripts/mysql_post_backup.sh
#!/bin/bash
mysql -u root -p"your_mysql_root_password" -e "UNLOCK TABLES;"

# Configurar el job de backup en Veeam para ejecutar estos scripts.
```

### 2.4. Backup AD (System State)

Para los Controladores de Dominio, se realizará un backup del *System State* para permitir la recuperación completa del Directorio Activo.

```bash
# En dc1 y dc2, el agente Veeam se configurará para incluir el System State en el job de backup.
# En Linux con Samba AD-DC, esto implica respaldar directorios críticos como /var/lib/samba.
```

---

## 3. Pruebas de Recuperación

Las pruebas de recuperación son esenciales para validar la estrategia de backup y asegurar que los datos pueden ser restaurados correctamente en caso de un desastre.

### 3.1. File-Level Recovery (Archivos Individuales)

| Prueba | Objetivo | Metodología | Criterio de Éxito |
| :--- | :--- | :--- | :--- |
| **Restauración de Archivo** | Recuperar un archivo específico de un servidor. | Eliminar un archivo de prueba en un servidor y restaurarlo desde el backup. | El archivo debe ser restaurado correctamente a su ubicación original o a una alternativa. |

### 3.2. VM-Level Recovery (Servidores Completos)

| Prueba | Objetivo | Metodología | Criterio de Éxito |
| :--- | :--- | :--- | :--- |
| **Restauración de VM** | Recuperar una máquina virtual completa. | Simular la pérdida de un servidor (ej. `webserver1`) y restaurar la VM desde el backup. | La VM debe arrancar y funcionar correctamente, con todos los servicios operativos. |

### 3.3. Bare-Metal Recovery (Simulado)

| Prueba | Objetivo | Metodología | Criterio de Éxito |
| :--- | :--- | :--- | :--- |
| **Recuperación Bare-Metal** | Simular la recuperación de un servidor físico desde cero. | Crear una nueva VM vacía y simular la restauración del backup completo del sistema operativo. | El sistema operativo debe arrancar y ser funcional, con el agente de backup instalado. |

### 3.4. Pruebas de Restauración de BD

| Prueba | Objetivo | Metodología | Criterio de Éxito |
| :--- | :--- | :--- | :--- |
| **Restauración de BD** | Recuperar la base de datos MySQL a un punto en el tiempo. | Eliminar una tabla o datos de la base de datos y restaurar el backup de la BD. | La base de datos debe ser restaurada a un estado consistente, con los datos recuperados. |
