# Guía de Implementación de Red Avanzada

**Proyecto:** QuickStay - Plataforma de Alquiler Express

**Módulo:** Administración de Sistemas Informáticos en Red (ASIR)

**Autor:** Antonio López Montes

**Fecha:** 23 de Diciembre de 2025

---

## 1. Configuración del Router/Firewall (Linux - iptables)

El Router/Firewall (FW) se implementará en una máquina virtual Linux (ej. Ubuntu Server), actuando como *gateway*, gestionando el tráfico WAN/LAN, el NAT y las políticas de seguridad con **iptables**.

### 1.1. Configuración de Interfaces y Routing

El FW utiliza la interfaz `enp0s3` para la WAN y `enp0s8` para la conexión *trunk* con el Switch L3.

| Interfaz | Dirección IP | Máscara | Función |
| :--- | :--- | :--- | :--- |
| **enp0s3** | 203.0.113.2 | /24 | WAN (Internet) |
| **enp0s8** | 172.16.0.1 | /16 | LAN (Gateway principal) |

```bash
# Habilitar el reenvío de paquetes (actuar como router)
echo 1 > /proc/sys/net/ipv4/ip_forward

# Configuración de Interfaz WAN
ip addr add 203.0.113.2/24 dev enp0s3
ip link set enp0s3 up

# Configuración de Interfaz LAN (Gateway principal)
ip addr add 172.16.0.1/16 dev enp0s8
ip link set enp0s8 up

# Routing Estático por Defecto
ip route add default via 203.0.113.1 dev enp0s3
```

### 1.2. NAT/PAT para Servicios DMZ

Se utiliza **DNAT (Destination NAT)** para publicar el Servidor Web (172.16.10.10) y **SNAT (Source NAT)** para permitir que la red interna acceda a Internet.

| Servicio | IP Interna | Puerto Interno | IP Externa | Puerto Externo |
| :--- | :--- | :--- | :--- | :--- |
| **HTTP** | 172.16.10.10 | 80 | 203.0.113.2 | 80 |
| **HTTPS** | 172.16.10.10 | 443 | 203.0.113.2 | 443 |

```bash
# 1. DNAT (NAT Estático) para el Servidor Web (Publicación de Servicios)
# Redirigir tráfico entrante a la IP pública (enp0s3) hacia el Servidor Web (DMZ)
iptables -t nat -A PREROUTING -i enp0s3 -p tcp --dport 80 -j DNAT --to-destination 172.16.10.10:80
iptables -t nat -A PREROUTING -i enp0s3 -p tcp --dport 443 -j DNAT --to-destination 172.16.10.10:443

# 2. SNAT (NAT Dinámico) para tráfico saliente de la red interna
# Enmascarar todo el tráfico saliente de la red 172.16.0.0/16
iptables -t nat -A POSTROUTING -s 172.16.0.0/16 -o enp0s3 -j MASQUERADE
```

### 1.3. ACLs de Seguridad (iptables - FILTER Table)

Se aplica una política de seguridad estricta, denegando todo por defecto y permitiendo solo el tráfico necesario.

```bash
# 1. Establecer políticas por defecto a DROP
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# 2. Permitir tráfico de loopback
iptables -A INPUT -i lo -j ACCEPT

# 3. Permitir tráfico de conexiones ya establecidas (STATEFUL)
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT

# 4. Permitir acceso público a la DMZ (Servidor Web) - Corresponde al DNAT
# Se permite el tráfico reenviado (FORWARD) a la DMZ
iptables -A FORWARD -i enp0s3 -o enp0s8 -p tcp --dport 80 -d 172.16.10.10 -j ACCEPT
iptables -A FORWARD -i enp0s3 -o enp0s8 -p tcp --dport 443 -d 172.16.10.10 -j ACCEPT

# 5. Permitir tráfico de la DMZ al Servidor de Aplicación (VLAN 20)
iptables -A FORWARD -i enp0s8 -o enp0s8 -p tcp -s 172.16.10.0/24 -d 172.16.20.10 --dport 8080 -j ACCEPT

# 6. Permitir tráfico saliente de la red interna (LAN) a Internet
iptables -A FORWARD -i enp0s8 -o enp0s3 -s 172.16.0.0/16 -j ACCEPT

# 7. Loguear y Denegar el resto del tráfico (Política por defecto)
iptables -A FORWARD -j LOG --log-prefix "IPTABLES_DROP: "
iptables -A FORWARD -j DROP
```

---

## 2. Configuración del Switch L3 y VLANs (Linux - Bridge/VLAN)

El Switch L3 se implementará en una máquina virtual Linux con capacidad de *bridging* y manejo de VLANs (ej. usando `bridge-utils` y `vlan`).

### 2.1. Creación de VLANs y Trunking

Se crea un *bridge* (`br0`) que actuará como el switch virtual. Las VLANs se crean como subinterfaces en la interfaz física (`enp0s9`) conectada a los servidores.

| VLAN | Nombre | Subred | Función |
| :--- | :--- | :--- | :--- |
| **10** | DMZ | 172.16.10.0/24 | Servidor Web |
| **20** | SERVICIOS | 172.16.20.0/24 | App/DB |
| **30** | GESTION | 172.16.30.0/24 | AD/Monitoreo/Seguridad |
| **40** | OT_IOT | 172.16.40.0/23 | Centralitas IoT |
| **50** | ADMIN_VPN | 172.16.50.0/26 | Conexiones VPN |

```bash
# 1. Instalar herramientas de VLAN (si no están)
# sudo apt install vlan bridge-utils

# 2. Habilitar el módulo 8021q
modprobe 8021q

# 3. Crear las subinterfaces VLAN en la interfaz física (enp0s9)
vconfig add enp0s9 10
vconfig add enp0s9 20
vconfig add enp0s9 30
vconfig add enp0s9 40
vconfig add enp0s9 50

# 4. Asignar las IPs de Gateway (Inter-VLAN Routing)
ip addr add 172.16.10.1/24 dev enp0s9.10
ip addr add 172.16.20.1/24 dev enp0s9.20
ip addr add 172.16.30.1/24 dev enp0s9.30
ip addr add 172.16.40.1/23 dev enp0s9.40
ip addr add 172.16.50.1/26 dev enp0s9.50

# 5. Levantar las interfaces
ip link set enp0s9.10 up
ip link set enp0s9.20 up
ip link set enp0s9.30 up
ip link set enp0s9.40 up
ip link set enp0s9.50 up

# 6. Configurar la ruta por defecto hacia el Firewall (172.16.0.1)
ip route add default via 172.16.0.1 dev enp0s8
```

### 2.2. Protocolos de Redundancia (STP)

El protocolo STP se gestiona a nivel de *bridge* en Linux.

```bash
# 1. Crear un bridge para la interfaz física (simulando el switch)
brctl addbr br0
brctl addif br0 enp0s9

# 2. Habilitar STP en el bridge
brctl stp br0 on
```

---

## 3. Diseño de Seguridad: ACLs Inter-VLAN (iptables - FORWARD Table)

Las ACLs Inter-VLAN se implementan en la tabla `FORWARD` del Firewall (FW) para controlar el tráfico entre las VLANs.

| Regla | Origen | Destino | Protocolo/Puerto | Justificación |
| :--- | :--- | :--- | :--- | :--- |
| **1** | DMZ (10) | Servicios (20) | TCP/8080 | Acceso del Servidor Web al Servidor de Aplicación. |
| **2** | Servicios (20) | Servicios (20) | TCP/3306 | Acceso del Servidor de Aplicación a la Base de Datos. |
| **3** | Servicios (20) | Gestión (30) | UDP/53, TCP/389 | Consulta de DNS y LDAP al AD-DC. |
| **4** | Gestión (30) | Todas | TCP/22 | Acceso SSH de administración. |
| **5** | OT/IoT (40) | Gestión (30) | TCP/53, 8086 | Autenticación AD-DC y envío de datos a Zabbix/Wazuh. |
| **6** | Admin VPN (50) | Gestión (30) | TCP/22, 3389 | Acceso SSH/RDP de administradores. |
| **7** | Todas | Todas | ICMP | Permitir PING para diagnóstico. |
| **8** | **Denegar** | **Todas** | **IP/any** | **Denegar todo el tráfico no especificado.** |

```bash
# 1. Limpiar reglas existentes
iptables -F
iptables -X

# 2. Políticas por defecto (ya definidas en la Sección 1.3)

# 3. Reglas de Reenvío (FORWARD) - ACLs Inter-VLAN

# Regla 1: DMZ (10) a Servicios (20) - App Server
iptables -A FORWARD -p tcp -s 172.16.10.0/24 -d 172.16.20.0/24 --dport 8080 -j ACCEPT

# Regla 2: Servicios (20) a Servicios (20) - DB (Asumimos que la DB está en la misma VLAN que la App)
# Si estuvieran en VLANs separadas, se usaría:
# iptables -A FORWARD -p tcp -s 172.16.20.10 -d 172.16.20.20 --dport 3306 -j ACCEPT

# Regla 3: Servicios (20) a Gestión (30) - DNS/LDAP
iptables -A FORWARD -p udp -s 172.16.20.0/24 -d 172.16.30.0/24 --dport 53 -j ACCEPT
iptables -A FORWARD -p tcp -s 172.16.20.0/24 -d 172.16.30.0/24 --dport 389 -j ACCEPT

# Regla 4: Gestión (30) a Todas - SSH
iptables -A FORWARD -p tcp -s 172.16.30.0/24 -d 172.16.0.0/16 --dport 22 -j ACCEPT

# Regla 5: OT/IoT (40) a Gestión (30) - AD/Monitoreo
iptables -A FORWARD -p udp -s 172.16.40.0/23 -d 172.16.30.0/24 --dport 53 -j ACCEPT
iptables -A FORWARD -p tcp -s 172.16.40.0/23 -d 172.16.30.0/24 --dport 8086 -j ACCEPT

# Regla 6: Admin VPN (50) a Gestión (30) - SSH/RDP
iptables -A FORWARD -p tcp -s 172.16.50.0/26 -d 172.16.30.0/24 --dport 22 -j ACCEPT
iptables -A FORWARD -p tcp -s 172.16.50.0/26 -d 172.16.30.0/24 --dport 3389 -j ACCEPT

# Regla 7: Permitir ICMP (Ping)
iptables -A FORWARD -p icmp -j ACCEPT

# Regla 8: Denegar todo lo demás (ya cubierto por la política por defecto DROP)
```

---

## 4. Conectividad Básica y Pruebas

### 4.1. Pruebas de Conectividad (Ping)

Se debe verificar la conectividad básica entre los *gateways* y los servidores.

| Origen | Destino | Comando de Prueba | Resultado Esperado |
| :--- | :--- | :--- | :--- |
| Servidor Web (10) | Gateway (172.16.10.1) | `ping 172.16.10.1` | Éxito |
| Servidor Web (10) | Servidor App (20) | `ping 172.16.20.10` | Éxito (Permitido por iptables) |
| Servidor App (20) | Servidor DB (20) | `ping 172.16.20.20` | Éxito (Misma VLAN) |
| Servidor App (20) | Internet (8.8.8.8) | `ping 8.8.8.8` | Éxito (Permitido por SNAT) |

### 4.2. Verificación de Políticas de Seguridad (iptables)

Se debe verificar que el tráfico **denegado** por la Matriz de Acceso sea bloqueado.

| Origen | Destino | Puerto | Resultado Esperado |
| :--- | :--- | :--- | :--- |
| DMZ (10) | Gestión (30) | SSH (22) | **Fallo** (Denegado por política FORWARD) |
| Servicios (20) | DMZ (10) | HTTP (80) | **Fallo** (Denegado por política FORWARD) |
| OT/IoT (40) | Servicios (20) | MySQL (3306) | **Fallo** (Denegado por política FORWARD) |

### 4.3. Documentación de Configuraciones

Una vez finalizadas las pruebas, se deben guardar las configuraciones y documentar el estado final.

```bash
# Guardar la configuración de iptables (ej. en Debian/Ubuntu)
iptables-save > /etc/iptables/rules.v4

# Comandos de Verificación
ip addr show
ip route show
iptables -L -v -n
```
