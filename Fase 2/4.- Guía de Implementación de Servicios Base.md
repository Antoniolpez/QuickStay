# Guía de Implementación de Servicios Base

**Proyecto:** QuickStay - Plataforma de Alquiler Express
**Módulo:** Administración de Sistemas Informáticos en Red (ASIR)
**Autor:** Antonio López Montes
**Fecha:** 7 de Enero de 2026

---

## 1. Active Directory con Redundancia

La implementación de un Directorio Activo redundante es crucial para la autenticación centralizada de usuarios (administradores) y dispositivos (centralitas IoT), garantizando alta disponibilidad y tolerancia a fallos.

### 1.1. Instalación y Configuración del AD-DC Primario (dc1)

Se utilizará **Samba AD-DC** en un servidor Linux (ej. Ubuntu Server) para emular la funcionalidad de un Controlador de Dominio de Windows.

**Servidor:** `dc1.quickstay.local`
**IP:** `172.16.30.10`
**Dominio:** `quickstay.local`

```bash
# 1. Actualizar el sistema
sudo apt update && sudo apt upgrade -y

# 2. Instalar Samba y dependencias
sudo apt install -y samba krb5-user krb5-config winbind libpam-winbind libnss-winbind

# 3. Configurar Kerberos (durante la instalación)
# Dominio por defecto: QUICKSTAY.LOCAL
# Servidor Kerberos: dc1.quickstay.local
# Servidor de administración: dc1.quickstay.local

# 4. Renombrar el archivo de configuración de Samba existente
sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.bak

# 5. Provisionar el dominio Active Directory
sudo samba-tool domain provision --realm=QUICKSTAY.LOCAL --domain=QUICKSTAY --adminpass='TuContraseñaSegura' --server-role=dc --dns-backend=SAMBA_INTERNAL --use-rfc2307 --function-level=2008_R2

# 6. Mover el archivo krb5.conf generado
sudo mv /var/lib/samba/private/krb5.conf /etc/krb5.conf

# 7. Reiniciar servicios
sudo systemctl unmask samba-ad-dc
sudo systemctl enable samba-ad-dc
sudo systemctl start samba-ad-dc
sudo systemctl stop smbd nmbd winbind
sudo systemctl disable smbd nmbd winbind

# 8. Configurar DNS en el servidor para que apunte a sí mismo
# Editar /etc/netplan/01-netcfg.yaml o /etc/resolv.conf
# nameservers: [172.16.30.10]
```

### 1.2. Instalación y Configuración del AD-DC Secundario (dc2)

Se añadirá un segundo Controlador de Dominio para redundancia y balanceo de carga.

**Servidor:** `dc2.quickstay.local`
**IP:** `172.16.30.11`

```bash
# 1. Actualizar el sistema e instalar Samba (igual que dc1)
sudo apt update && sudo apt upgrade -y
sudo apt install -y samba krb5-user krb5-config winbind libpam-winbind libnss-winbind

# 2. Configurar DNS en dc2 para que apunte a dc1
# nameservers: [172.16.30.10]

# 3. Unir dc2 al dominio existente como un DC adicional
sudo samba-tool domain join QUICKSTAY.LOCAL DC -U 
Administrator --password=\'TuContraseñaSegura\'

# 4. Mover el archivo krb5.conf generado
sudo mv /var/lib/samba/private/krb5.conf /etc/krb5.conf

# 5. Reiniciar servicios
sudo systemctl unmask samba-ad-dc
sudo systemctl enable samba-ad-dc
sudo systemctl start samba-ad-dc
sudo systemctl stop smbd nmbd winbind
sudo systemctl disable smbd nmbd winbind

# 6. Configurar DNS en el servidor para que apunte a sí mismo y al otro DC
# Editar /etc/netplan/01-netcfg.yaml o /etc/resolv.conf
# nameservers: [172.16.30.11, 172.16.30.10]
```

### 1.3. Configuración de Replicación AD (Sitio a Sitio)

Samba AD-DC gestiona la replicación automáticamente una vez que un DC adicional se une al dominio. Sin embargo, es importante verificar la configuración.

```bash
# En dc1 o dc2, verificar el estado de la replicación
sudo samba-tool drs showrepl

# Verificar los objetos de replicación en LDAP
sudo ldbsearch -H /var/lib/samba/private/sam.ldb -b "cn=Configuration,dc=quickstay,dc=local" "(objectClass=nTDSConnection)"
```

### 1.4. Verificación de Replicación SYSVOL

SYSVOL es una carpeta compartida que almacena archivos de políticas de grupo y scripts de inicio de sesión. Su replicación es crítica para la consistencia del dominio.

```bash
# En ambos DCs, verificar el estado de rsync (o el método de replicación configurado)
sudo systemctl status rsync

# Verificar el contenido de la carpeta SYSVOL
ls -l /var/lib/samba/sysvol/quickstay.local/Policies

# Crear un archivo de prueba en dc1 y verificar su aparición en dc2
# En dc1:
sudo touch /var/lib/samba/sysvol/quickstay.local/Policies/{GUID_DE_UNA_POLITICA}/test_file.txt
# En dc2, verificar:
ls -l /var/lib/samba/sysvol/quickstay.local/Policies/{GUID_DE_UNA_POLITICA}/test_file.txt
```

---

## 2. Servicios DNS Redundantes

Los Controladores de Dominio (dc1 y dc2) actuarán como servidores DNS primarios y secundarios, proporcionando redundancia para la resolución de nombres.

### 2.1. Zonas DNS Primarias y Secundarias

Samba AD-DC configura automáticamente las zonas DNS necesarias (`quickstay.local` y la zona inversa) durante el provisionamiento y la unión al dominio.

```bash
# En dc1 o dc2, verificar las zonas DNS
sudo samba-tool dns zonequery dc1 quickstay.local
sudo samba-tool dns zonequery dc1 16.172.in-addr.arpa
```

### 2.2. Registros A, CNAME, MX, SRV

Los registros esenciales (A, CNAME, SRV para servicios AD) se crean automáticamente. Se pueden añadir registros adicionales según sea necesario.

| Tipo de Registro | Nombre | Valor | Justificación |
| :--- | :--- | :--- | :--- |
| **A** | `web` | `172.16.10.10` | Servidor Web |
| **A** | `app` | `172.16.20.10` | Servidor de Aplicación |
| **A** | `db` | `172.16.20.20` | Servidor de Base de Datos |
| **A** | `security` | `172.16.30.30` | Servidor de Seguridad |
| **CNAME** | `www` | `web.quickstay.local` | Alias para el Servidor Web |
| **SRV** | `_ldap._tcp.quickstay.local` | `dc1.quickstay.local` | Servicio LDAP para autenticación |

```bash
# Añadir un registro A para el Servidor Web en dc1
sudo samba-tool dns add dc1 quickstay.local web A 172.16.10.10 -k yes

# Añadir un registro CNAME para www en dc1
sudo samba-tool dns add dc1 quickstay.local www CNAME web.quickstay.local -k yes

# Verificar los registros
sudo samba-tool dns query dc1 quickstay.local web A
```

### 2.3. Configuración de Forwarders

Los servidores DNS internos deben reenviar las consultas para dominios externos a servidores DNS públicos (ej. Google DNS).

```bash
# En ambos DCs, editar el archivo smb.conf
sudo nano /etc/samba/smb.conf

# Añadir o modificar la sección [global] con:
# dns forwarder = 8.8.8.8
# dns forwarder = 8.8.4.4

# Reiniciar Samba AD-DC
sudo systemctl restart samba-ad-dc
```

### 2.4. Pruebas de Resolución y Failover

```bash
# En un cliente o servidor unido al dominio, configurar DNS para usar dc1 y dc2
# nameservers: [172.16.30.10, 172.16.30.11]

# Probar resolución de nombres internos
dig web.quickstay.local
dig dc2.quickstay.local

# Probar resolución de nombres externos
dig google.com

# Probar failover: Detener el servicio Samba AD-DC en dc1 y verificar que dc2 sigue resolviendo
# En dc1:
sudo systemctl stop samba-ad-dc
# En el cliente, repetir las pruebas de resolución.
```

---

## 3. DHCP y Otros Servicios Base

### 3.1. Ámbitos DHCP por VLAN (Exclusiones Reservadas)

Se configurará un servidor DHCP (ej. `isc-dhcp-server`) en la VLAN 30 (Gestión) para asignar IPs dinámicamente a las VLANs 40 (OT/IoT) y 50 (Administración VPN).

**Servidor:** `dc1.quickstay.local` (o un servidor dedicado)

```bash
# 1. Instalar el servidor DHCP
sudo apt install -y isc-dhcp-server

# 2. Configurar la interfaz de escucha (ej. eth2.40 y eth2.50 si el DHCP está en el Switch L3, o eth1 si está en el FW)
# Editar /etc/default/isc-dhcp-server
# INTERFACESv4="eth2.40 eth2.50"

# 3. Configurar los ámbitos DHCP
# Editar /etc/dhcp/dhcpd.conf

# Ámbito para VLAN 40 (OT/IoT)
subnet 172.16.40.0 netmask 255.255.254.0 {
  range 172.16.40.100 172.16.41.250;
  option routers 172.16.40.1;
  option domain-name-servers 172.16.30.10, 172.16.30.11;
  option domain-name "quickstay.local";
  default-lease-time 600;
  max-lease-time 7200;
  # Exclusiones y Reservas (ej. para centralitas IoT específicas)
  # host centralita1 { fixed-address 172.16.40.50; hardware ethernet AA:BB:CC:DD:EE:FF; }
}

# Ámbito para VLAN 50 (Administración VPN)
subnet 172.16.50.0 netmask 255.255.255.192 {
  range 172.16.50.10 172.16.50.60;
  option routers 172.16.50.1;
  option domain-name-servers 172.16.30.10, 172.16.30.11;
  option domain-name "quickstay.local";
  default-lease-time 600;
  max-lease-time 7200;
}

# 4. Reiniciar el servicio DHCP
sudo systemctl restart isc-dhcp-server
```

### 3.2. Servidor NTP (Sincronización Horaria)

La sincronización horaria es crítica para la seguridad (logs, certificados) y la funcionalidad de AD. Los DCs actuarán como servidores NTP.

```bash
# En dc1 y dc2, configurar NTP para sincronizar con fuentes externas y servir a la red interna
sudo apt install -y ntp

# Editar /etc/ntp.conf
# server 0.pool.ntp.org iburst
# server 1.pool.ntp.org iburst
# ...
# restrict 172.16.0.0 mask 255.255.0.0 nomodify notrap

# Reiniciar NTP
sudo systemctl restart ntp

# En clientes, configurar para usar los DCs como servidores NTP
# ntpdate -u 172.16.30.10
```

### 3.3. Servidor de Logs Centralizado

Se utilizará el Servidor de Seguridad (Wazuh) como sistema de gestión de eventos e información de seguridad (SIEM) para centralizar los logs de todos los sistemas.

```bash
# 1. Configurar agentes Wazuh en todos los servidores (Web, App, DB, AD-DC, Switch L3)
# La instalación del agente Wazuh se realiza siguiendo la documentación oficial.
# El agente se configura para enviar logs al Servidor de Seguridad (172.16.30.30).

# 2. En el Servidor de Seguridad (Wazuh Manager), verificar la recepción de logs
# Acceder a la interfaz web de Wazuh (Kibana/OpenSearch Dashboards) para visualizar los logs y alertas.

# Ejemplo de configuración de rsyslog para enviar logs a Wazuh (en un cliente)
# Editar /etc/rsyslog.conf
# *.* @172.16.30.30:514
# Reiniciar rsyslog
sudo systemctl restart rsyslog
```
